#!/bin/sh

# launch --- A launcher script for several R6RS implementations

# Copyright (C) 2009, 2010 Andreas Rottmann <a.rottmann@gmx.at>

# This program is free software, you can redistribute it and/or
# modify it under the terms of the new-style BSD license.

# You should have received a copy of the BSD license along with this
# program. If not, see <http://www.debian.org/misc/bsd.license>.


#
# helpers
#

clean_symlink_tree() {
    if [ ! -d "$1" ]; then
        return
    fi
    find "$1" -depth \( -type l -o \( -type d -empty \) \) -delete
}

make_symlinks() {
    local dir="$1"; shift
    clean_symlink_tree "$dir"
    if ! command -v doro > /dev/null; then
        echo "ERROR: 'doro' command not found, please install dorodango."
        echo "See http://home.gna.org/dorodango/manual/#installation for details"
        exit 1
    fi
    doro --no-config symlink-bundle --force "$@" systems "$dir"
}

#
# main script
#

set -e

impl="$1"
if [ -z "$impl" ]; then
    echo "Usage: scripts/launch <impl> [<command> [<option> ...]]"
    exit 1
fi

if command -v rlwrap > /dev/null; then
    rlwrap=rlwrap
else
    rlwrap=""
fi


# A reasonable default
symlink="make_symlinks r6rs-libs"

# implementation specifics
impl="$1"; shift
case "$impl" in
    ikarus)
        export IKARUS_LIBRARY_PATH="`pwd`/r6rs-libs:$IKARUS_LIBRARY_PATH"
        run_r6rs_script="ikarus --r6rs-script"
        repl="$rlwrap ikarus"
        ;;
    mzscheme)
        export PLTCOLLECTS=":$PLTCOLLECTS:`pwd`/plt-r6rs"
        run_r6rs_script="plt-r6rs"
        repl="$rlwrap mzscheme -i"
        symlink="make_symlinks plt-r6rs --exclude srfi"
        ;;
    ypsilon)
        export YPSILON_SITELIB="`pwd`/r6rs-libs:$YPSILON_SITELIB"
        run_r6rs_script="ypsilon --r6rs"
        repl="$rlwrap ypsilon"
        ;;
    larceny)
        run_r6rs_script="larceny -r6rs -path `pwd`/r6rs-libs -program"
        repl="$rlwrap larceny -path `pwd`/r6rs-libs -err5rs"
        ;;
    mosh)
        export MOSH_LOADPATH="`pwd`/r6rs-libs"
        run_r6rs_script="mosh"
        repl="$rlwrap mosh"
        ;;
    guile)
        export GUILE_LOAD_PATH="`pwd`/guile-r6rs"
        run_r6rs_script="guile -x .guile.sls -x .sls -s"
        repl="guile -l scripts/guile-config.scm"
        symlink="make_symlinks guile-r6rs --exclude srfi"
        ;;
    *)
        echo "ERROR: Unsupported implementation '$impl'; patches welcome ;-)"
        exit 1
        ;;
esac

if [ $# -eq 0 ]; then
    $repl
    exit 0
fi

# command dispatcher

case "$1" in
    symlink)
        shift
        $symlink
        ;;
    build)
        shift
        $symlink
        $run_r6rs_script scripts/build.sps "$@"
        ;;
    test)
        shift
        test_file="systems/$1/tests/tests.scm"
        shift
        $run_r6rs_script scripts/run-tests.sps "$test_file" "$@"
        ;;
    pull)
        shift
        $run_r6rs_script systems/conjure/scripts/rcs42.sps pull "$@"
        $symlink
        $run_r6rs_script scripts/build.sps
        ;;
    push)
        shift
        $run_r6rs_script systems/conjure/scripts/rcs42.sps push "$@"
        ;;
    diff)
        shift
        $run_r6rs_script systems/conjure/scripts/rcs42.sps diff "$@"
        ;;
    make-doc)
        rm -f doc/html/system-reference/*.*.html doc/html/system-reference/index.html
        $run_r6rs_script systems/stexidoc/scripts/make-doc.sps \
            "SPE system reference" doc/html/system-reference systems/*/sys-def.scm
        ;;
    *)
        $run_r6rs_script "$@"
        ;;
esac
